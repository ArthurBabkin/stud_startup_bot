from app.config import config
from openai import OpenAI
from app.services import db_service
from aiogram.types import Message


# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á API –¥–ª—è OpenAI
# –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –≤–µ—Å—å –º–æ–¥—É–ª—å
client = OpenAI(api_key=config.openai_key)
ASSISTANT_ID = config.assistant_id

def get_or_create_thread(tg_user_id: int) -> str:
    thread_id = db_service.get_thread(tg_user_id)
    if thread_id:
        return thread_id

    thread = client.beta.threads.create()
    db_service.save_thread(tg_user_id, thread.id)
    return thread.id

# app/services/openai_service.py
async def ask_openai(prompt: str, tg_user_id: int) -> str:
    thread_id = get_or_create_thread(tg_user_id)

    # 1) –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    client.beta.threads.messages.create(
        thread_id=thread_id,
        role="user",
        content=prompt,
    )

    # 2) –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–Ω –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    run = client.beta.threads.runs.create_and_poll(
        thread_id=thread_id,
        assistant_id=ASSISTANT_ID,
    )

    if run.status != "completed":
        return f"‚ö†Ô∏è OpenAI: run finished with status {run.status}"

    # 3) –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    last_msg = client.beta.threads.messages.list(
        thread_id=thread_id,
        limit=1
    ).data[0]

    parts = [
        block.text.value
        for block in last_msg.content
        if block.type == "text"
    ]
    return "\n".join(parts).strip() or "‚ö†Ô∏è –û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞"



async def ask_deepseek(prompt: str, message: Message) -> str:
    client = OpenAI(api_key=config.deepseek_key,
                    base_url="https://api.deepseek.com")

    system = (
        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ –∑–∞—è–≤–æ–∫ –Ω–∞ –∫–æ–Ω–∫—É—Ä—Å ¬´–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø¬ª –æ—Ç –§–æ–Ω–¥–∞ —Å–æ–¥–µ–π—Å—Ç–≤–∏—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º (–§–°–ò). "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é –∑–∞—è–≤–∫—É –∏ –≤—ã–¥–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —à–∞–Ω—Å–æ–≤ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞.\n\n"
    
        "–¢—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å –∑–∞—è–≤–∫—É –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–ª—é—á–µ–≤—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:\n\n"
    
        "üîπ 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:\n"
        "- –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –ª–∏ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã (–¥–∞–Ω–Ω—ã–µ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ, –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è, —Ü–µ–ª–∏, –∑–∞–¥–∞—á–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, –ø–ª–∞–Ω —Ä–∞–±–æ—Ç, –±—é–¥–∂–µ—Ç)?\n"
        "- –ù–µ—Ç –ª–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∏–ª–∏ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π?\n"
        "- –û—Ñ–æ—Ä–º–ª–µ–Ω–∞ –ª–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ, –±–µ–∑ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫?\n\n"
    
        "üîπ 2. –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Ñ–æ–∫—É—Å:\n"
        "- –ù–∞—Å–∫–æ–ª—å–∫–æ —á—ë—Ç–∫–æ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ —Ü–µ–ª—å?\n"
        "- –ü–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ –æ–¥–Ω–æ –∏–∑ –∫–æ–Ω–∫—É—Ä—Å–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ù1 ‚Äì –¶–∏—Ñ—Ä–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)?\n"
        "- –£–∫–∞–∑–∞–Ω—ã –ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–æ–¥–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4.04 ‚Äì –ò–ò, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π)?\n\n"
    
        "üîπ 3. –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:\n"
        "- –û—Ç—Ä–∞–∂–∞–µ—Ç –ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è —Å—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞?\n"
        "- –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–æ–≤—ã–º, –ø—Ä–∏–º–µ–Ω–∏–º—ã–º –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–º?\n\n"
    
        "üîπ 4. –ö–æ–º–∞–Ω–¥–∞:\n"
        "- –£–∫–∞–∑–∞–Ω–∞ –ª–∏ —Ä–æ–ª—å –∑–∞—è–≤–∏—Ç–µ–ª—è –∏ –µ–≥–æ –æ–ø—ã—Ç?\n"
        "- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ª–∏ —Ä–æ–ª–∏ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ–ø—ã—Ç?\n"
        "- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –≤ –∫–æ–º–∞–Ω–¥–µ?\n\n"
    
        "üîπ 5. –ë–∏–∑–Ω–µ—Å-—á–∞—Å—Ç—å:\n"
        "- –£–∫–∞–∑–∞–Ω–∞ –ª–∏ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å (B2B/B2C)?\n"
        "- –ï—Å—Ç—å –ª–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —Ä—ã–Ω–∫–∞, —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏?\n"
        "- –£–∫–∞–∑–∞–Ω–æ –ª–∏, –Ω–∞ –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–π–¥—É—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –≥—Ä–∞–Ω—Ç–∞?\n\n"
    
        "üîπ 6. –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –ø–ª–∞–Ω –∏ –±—é–¥–∂–µ—Ç:\n"
        "- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã –ª–∏ —Å—Ä–æ–∫–∏?\n"
        "- –ü—Ä–æ–ø–∏—Å–∞–Ω—ã –ª–∏ —ç—Ç–∞–ø—ã –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ?\n"
        "- –ï—Å—Ç—å –ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞ –ø–æ —ç—Ç–∞–ø–∞–º?\n\n"
    
        "üîπ 7. –û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –§–°–ò:\n"
        "- –£–∫–∞–∑–∞–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –û–û–û, —É—á–∞—Å—Ç–∏–µ –≤ –∑–∞—â–∏—Ç–µ, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤?\n"
        "- –ù–µ—Ç –ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π ‚Äì –ò–ü, –û–û–û —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –∑–∞—Ä–∞–Ω–µ–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–∞–≤–æ–∫ –∏ —Ç.–ø.?\n\n"
    
        "–û—Ü–µ–Ω–∏ –∑–∞—è–≤–∫—É –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–ª—é—á–µ–≤—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∏–∑ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞:\n\n"

        "üîπ 1. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (–¥–æ 5 –±–∞–ª–ª–æ–≤):\n"
        "- –û—Ü–µ–Ω–∏ –Ω–∞–ª–∏—á–∏–µ, —É—Ä–æ–≤–µ–Ω—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ø–ª–∞–Ω –µ—ë –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.\n"
        "- –£—á–∏—Ç—ã–≤–∞–π –Ω–∞–ª–∏—á–∏–µ –Ω–∞—É—á–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –Ω–æ–≤–∏–∑–Ω—ã, —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏, –Ω–∞–ª–∏—á–∏–µ –ò–°, –ø–∞—Ç–µ–Ω—Ç–æ–≤, –≤–Ω–µ–¥—Ä—è–µ–º–æ—Å—Ç—å.\n\n"
    
        "üîπ 2. –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∫–æ–º–º–µ—Ä—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–¥–æ 5 –±–∞–ª–ª–æ–≤):\n"
        "- –ï—Å—Ç—å –ª–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—à–µ–Ω–∏–π?\n"
        "- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫ (–æ–±—ä—ë–º, —Å–µ–≥–º–µ–Ω—Ç—ã, —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è), –µ—Å—Ç—å –ª–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫.\n\n"
    
        "üîπ 3. –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞—è–≤–∏—Ç–µ–ª—è (–¥–æ 5 –±–∞–ª–ª–æ–≤):\n"
        "- –£–∫–∞–∑–∞–Ω –ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ–ø—ã—Ç, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —É—á–∞—Å—Ç–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö/–∫–æ–Ω–∫—É—Ä—Å–∞—Ö/–ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–°—Ç–∞—Ä—Ç –¥–ª—è –¥–∏–ø–ª–æ–º–∞', –ú–®–£, –∞–∫—Å–µ–ª–µ—Ä–∞—Ç–æ—Ä—ã)?\n"
        "- –û—Ç—Ä–∞–∂–µ–Ω—ã –ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –ò–¢, –∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–µ, –±–∏–∑–Ω–µ—Å–µ?\n\n"
    
        "üîπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å:\n"
        "- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞—è–≤–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º: —Å—Ç—É–¥–µ–Ω—Ç, —Å–æ–∑–¥–∞–Ω–∏–µ –û–û–û, —Å–∞–π—Ç –ø—Ä–æ–µ–∫—Ç–∞, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –ø–æ —ç—Ç–∞–ø–∞–º.\n"
        "- –ù–µ—Ç –ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π (–ò–ü, –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è, –¥—É–±–ª–∏, –Ω–µ—Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞).\n\n"
    
        "–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–¥–∞–π:\n"
        "1. –û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∑–∞—è–≤–∫–∏)\n"
        "2. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã\n"
        "3. –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ (–ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º)\n"
        "4. –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É\n"
        "5. –û—Ü–µ–Ω–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é –æ—Ç 1 –¥–æ 5 –±–∞–ª–ª–æ–≤:\n"
        "- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞: X/5\n"
        "- –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∫–æ–º–º–µ—Ä—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: X/5\n"
        "- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞—è–≤–∏—Ç–µ–ª—è: X/5\n\n"
    
        "–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ (–Ω–µ markdown), "
        "—á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—ã–ª –∫—Ä–∞—Å–∏–≤—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–ª—è Telegram —Å–æ–æ–±—â–µ–Ω–∏—è."
        "–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏: 'b', 'i', 'blockquote'.\n"
        "–ù–µ —Å–æ–∫—Ä–∞—â–∞–π, –±—É–¥—å –¥–µ—Ç–∞–ª—å–Ω—ã–º, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ –æ–ø—ã—Ç–µ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞—è–≤–æ–∫."
        )

    resp = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": prompt},
        ],
        max_tokens=3000,
    )

    return resp.choices[0].message.content